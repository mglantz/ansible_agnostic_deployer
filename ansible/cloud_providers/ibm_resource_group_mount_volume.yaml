---
# STEP: Discover the device on the host by matching its serial number.
- name: "Find device for volume ID {{ _volume.id }}"
  ansible.builtin.set_fact:
    _matched_device: >-
      {{ _host_block_devices
      | selectattr('serial', 'defined')
      | selectattr('serial', '!=', None)
      | selectattr('serial', 'in', _volume.id)
      | list | first
      }}

- name: "Verify a device was found"
  ansible.builtin.fail:
    msg: "Could not find a matching block device on host for volume ID {{ _volume.id }}"
  when: _matched_device is not defined

# STEP: Create the filesystem.
- name: "Create {{ _volume.fstype | default('xfs') }} filesystem on {{ _matched_device.path }}"
  community.general.filesystem:
    fstype: "{{ _volume.fstype | default('xfs') }}" # Default to xfs
    dev: "{{ _matched_device.path }}"
  register: _filesystem_result

# STEP: Get the new filesystem's UUID for robust mounting.
- name: "Get filesystem UUID from {{ _matched_device.path }}"
  ansible.builtin.command: "blkid -s UUID -o value {{ _matched_device.path }}"
  register: _blkid_result
  changed_when: false

- name: Set filesystem UUID fact
  ansible.builtin.set_fact:
    _device_uuid: "{{ _blkid_result.stdout }}"
  when: _blkid_result.stdout != ""

# STEP: Mount the volume using its UUID.
- name: "Ensure mount point {{ _volume.mount }} exists"
  ansible.builtin.file:
    path: "{{ _volume.mount }}"
    state: directory
    mode: '0755'
  when: _volume.mount is defined

- name: "Mount device at {{ _volume.mount }} using its UUID"
  ansible.posix.mount:
    path: "{{ _volume.mount }}"
    src: "UUID={{ _device_uuid }}"
    fstype: "{{ _volume.fstype | default('xfs') }}" # Default to xfs
    opts: "{{ _volume.mount_opts | default(omit) }}" # Add custom mount options
    state: mounted
  when:
    - _volume.mount is defined
    - _device_uuid is defined
