---
- name: Step 001.1 Deploy Infrastructure
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tags:
    - step001
    - step001.1
    - deploy_infrastructure
    - infra
    - infra_tasks
  module_defaults:
    ibm.cloudcollection.ibm_resource_group:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
    ibm.cloudcollection.ibm_is_ssh_key:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
      region: "{{ ibmcloud_region }}"
    ibm.cloudcollection.ibm_is_ssh_key_info:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
      region: "{{ ibmcloud_region }}"
    ibm.cloudcollection.ibm_is_vpc:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
      region: "{{ ibmcloud_region }}"
    ibm.cloudcollection.ibm_is_subnet:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
      region: "{{ ibmcloud_region }}"
    ibm.cloudcollection.ibm_is_security_group:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
      region: "{{ ibmcloud_region }}"
    ibm.cloudcollection.ibm_is_security_group_rule:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
      region: "{{ ibmcloud_region }}"
    ibm.cloudcollection.ibm_is_instance:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
      region: "{{ ibmcloud_region }}"
    ibm.cloudcollection.ibm_is_images_info:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
    ibm.cloudcollection.ibm_is_floating_ip:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
      region: "{{ ibmcloud_region }}"
    ibm.cloudcollection.ibm_is_instances_info:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
      region: "{{ ibmcloud_region }}"
  tasks:
    - name: Create ssh provision key
      ansible.builtin.include_role:
        name: create_ssh_provision_key
      when:
        - instances | default([]) | length
        - ssh_provision_key_name is undefined

    - name: Run infra-ibm-resource-group-resources Role
      ansible.builtin.include_role:
        name: infra-ibm-resource-group-resources
      vars:
        ACTION: provision

- name: Step 001.2 Create Inventory and SSH config setup
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tags:
    - step001
    - step001.2
    - create_inventory
    - create_ssh_config
  module_defaults:
    ibm.cloudcollection.ibm_is_instances_info:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
      region: "{{ ibmcloud_region }}"
    ibm.cloudcollection.ibm_is_floating_ips_info:
      ibmcloud_api_key: "{{ ibmcloud_api_key }}"
      region: "{{ ibmcloud_region }}"
  tasks:

    - name: Run infra-dns Role
      when: cluster_dns_server is defined or route53_aws_zone_id is defined
      ansible.builtin.include_role:
        name: infra-dns
      vars:
        _dns_state: present

    - name: Run infra-ibm-resource-group-create-inventory Role
      ansible.builtin.import_role:
        name: infra-ibm-resource-group-create-inventory

    - name: Run Common SSH Config Generator Role
      ansible.builtin.import_role:
        name: infra-common-ssh-config-generate
      when: "instances|default(False) and 'bastions' in groups"

# include global vars again, this time for all hosts now that the inventory is built
- import_playbook: ../include_vars.yml
  tags:
    - create_inventory
    - must

- name: Step 001.3 Configure Linux Hosts and Wait for Connection
  hosts:
    - all:!windows:!network
  gather_facts: false
  any_errors_fatal: true
  ignore_errors: false
  become: true
  tags:
    - step001
    - step001.3
    - wait_ssh
    - set_hostname
  tasks:
    - name: set facts for remote access
      tags:
        - create_inventory
      ansible.builtin.set_fact:
        ansible_ssh_extra_args: >-
          {{ ansible_ssh_extra_args|d() }}
          -F {{output_dir}}/{{ env_type }}_{{ guid }}_ssh_conf

    - name: Run infra-generic-wait_for_linux_hosts Role
      ansible.builtin.include_role:
        name: infra-generic-wait_for_linux_hosts
      vars:
        infra_generic_wait_for_linux_hosts_delay: 1
        infra_generic_wait_for_linux_hosts_sleep: 5
        infra_generic_wait_for_linux_hosts_connect_timeout: 20
        infra_generic_wait_for_linux_hosts_timeout: 300
        infra_generic_wait_for_linux_hosts_retries: 25

    - name: Add authorized_keys
      ansible.builtin.include_role:
        name: ssh_authorized_keys
      when: >-
        ssh_authorized_keys | default([]) | length > 0
        or
        all_ssh_authorized_keys | default([]) | length > 0

    - name: Set volumes fact using deployer(localhost) from previous steps
      set_fact:
        host_ibmcloud_volumes: >-
          {{ hostvars.localhost.get('ibmcloud_volumes', {})[inventory_hostname] | default([]) }}

    - name: DEBUG | Show the volumes fact received by this host
      ansible.builtin.debug:
        var: host_ibmcloud_volumes
        verbosity: 2

    - name: Format and mount disks if any
      when: host_ibmcloud_volumes | length > 0
      block:
        # Gather block device info from the host (runs once per host).
        - name: Get block device details
          ansible.builtin.command: lsblk -O --json
          register: _lsblk_output
          changed_when: false

        - name: Parse block device details into a fact
          ansible.builtin.set_fact:
            _host_block_devices: "{{ (_lsblk_output.stdout | from_json).blockdevices }}"

        - debug:
            verbosity: 2
            var: _host_block_devices

        - name: Process volumes that need formatting or mounting
          loop: "{{ host_ibmcloud_volumes }}"
          loop_control:
            loop_var: _volume
            label: "{{ _volume.name | default(_volume.id) }}"
          ansible.builtin.include_tasks: ibm_resource_group_mount_volume.yaml
          when: _volume.fstype is defined or _volume.mount is defined
