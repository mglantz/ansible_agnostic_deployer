---
- name: Set variables
  ansible.builtin.set_fact:
    RESOURCEGROUP: "{{ azure_resource_group }}"
    SERVICE_ACCOUNT_NAMESPACE: "{{ open_env_azure_aro_ai_search_sa_namespace | default('user') }}"
    SERVICE_ACCOUNT_NAME: "{{ open_env_azure_aro_ai_search_sa_name | default('user') }}"
    AI_SUBSCRIPTION: "{{ open_env_azure_aro_ai_search_user_ai_sub }}"
    AI_RESOURCEGROUP: "{{ open_env_azure_aro_ai_search_user_ai_rg }}"
    AI_SEARCH_NAME: "{{ open_env_azure_aro_ai_search_user_ai_search_name }}"
    AI_NAME: "{{ open_env_azure_aro_ai_search_user_ai_name }}"
    OCP4_WORKLOAD_USER_COUNT: "{{ ocp4_workload_user_count | default(1) }}"
    LOCATION: "{{ open_env_azure_aro_ai_search_location | default('eastus') }}"

- name: Set derived variables
  ansible.builtin.set_fact:
    USER_ASSIGNED_IDENTITY_NAME: "{{ RESOURCEGROUP }}-identity"
    FEDERATED_IDENTITY_CREDENTIAL_NAME_PREFIX: "{{ RESOURCEGROUP }}-federated-identity"
    SERVICE_ACCOUNT_BASE_NAMESPACE: "{{ SERVICE_ACCOUNT_NAMESPACE }}"
    SERVICE_ACCOUNT_BASE_NAME: "{{ SERVICE_ACCOUNT_NAME }}"
    
- name: Verify required variables are set
  assert:
    that:
      - RESOURCEGROUP is defined
      - AI_SUBSCRIPTION is defined
    fail_msg: "Required variables (RESOURCEGROUP, AI_SUBSCRIPTION) are not defined"
    
- name: Set AI scope variables
  set_fact:
    AI_SEARCH_SCOPE: "/subscriptions/{{ AI_SUBSCRIPTION }}/resourceGroups/{{ AI_RESOURCEGROUP }}/providers/Microsoft.Search/searchServices/{{ AI_SEARCH_NAME }}"
    AI_SCOPE: "/subscriptions/{{ AI_SUBSCRIPTION }}/resourceGroups/{{ AI_RESOURCEGROUP }}/providers/Microsoft.CognitiveServices/accounts/{{ AI_NAME }}"
    
- name: Get ARO OIDC Issuer URL
  shell: |
    oc get authentication cluster -o jsonpath='{.spec.serviceAccountIssuer}'
  register: aro_oidc_issuer
  changed_when: false
    
- name: Set ARO_OIDC_ISSUER fact
  set_fact:
    ARO_OIDC_ISSUER: "{{ aro_oidc_issuer.stdout }}"
    
- name: Create identities and configure access for each user
  block:
    - name: Create user-assigned identity
      shell: |
        az identity create \
          --name "{{ RESOURCEGROUP }}-user{{ item }}-identity" \
          --resource-group "{{ RESOURCEGROUP }}" \
          --location "{{ LOCATION }}"
      register: create_identity
      loop: "{{ range(1, OCP4_WORKLOAD_USER_COUNT|int + 1)|list }}"
      when: OCP4_WORKLOAD_USER_COUNT|int > 0
    
    - name: Get identity object IDs
      shell: |
        az identity show \
          --name "{{ RESOURCEGROUP }}-user{{ item }}-identity" \
          --resource-group "{{ RESOURCEGROUP }}" \
          --query 'principalId' -otsv
      register: identity_object_ids
      loop: "{{ range(1, OCP4_WORKLOAD_USER_COUNT|int + 1)|list }}"
      when: OCP4_WORKLOAD_USER_COUNT|int > 0

    - name: Show raw registered variable
      debug:
        var: identity_object_ids
    
    - name: Get identity client IDs
      shell: |
        az identity show \
          --name "{{ RESOURCEGROUP }}-user{{ item }}-identity" \
          --resource-group "{{ RESOURCEGROUP }}" \
          --query 'clientId' -otsv
      register: identity_client_ids
      loop: "{{ range(1, OCP4_WORKLOAD_USER_COUNT|int + 1)|list }}"
      when: OCP4_WORKLOAD_USER_COUNT|int > 0

    - name: Show raw registered variable
      debug:
        var: identity_client_ids

    - name: Assign Search Index Data Reader role for each identity
      shell: |
        az role assignment create \
          --assignee-object-id "{{ identity_object_ids.results[item|int - 1].stdout }}" \
          --role "Search Index Data Reader" \
          --scope "{{ AI_SEARCH_SCOPE }}" \
          --assignee-principal-type ServicePrincipal
      register: index_data_reader_role
      loop: "{{ range(1, OCP4_WORKLOAD_USER_COUNT|int + 1)|list }}"
      when: OCP4_WORKLOAD_USER_COUNT|int > 0

    - name: Show raw registered variable
      debug:
        var: index_data_reader_role
    
    - name: Assign Cognitive Services OpenAI User role for each identity
      shell: |
        az role assignment create \
          --assignee-object-id "{{ identity_object_ids.results[item|int - 1].stdout }}" \
          --role "Cognitive Services OpenAI User" \
          --scope "{{ AI_SCOPE }}" \
          --assignee-principal-type ServicePrincipal
      register: cognitive_service_openai_role    
      loop: "{{ range(1, OCP4_WORKLOAD_USER_COUNT|int + 1)|list }}"
      when: OCP4_WORKLOAD_USER_COUNT|int > 0

    - name: Show raw registered variable
      debug:
        var: cognitive_service_openai_role

    - name: Create federated identity credentials for each user
      shell: |
        az identity federated-credential create \
          --name "{{ RESOURCEGROUP }}-user{{ item }}-federated-identity" \
          --identity-name "{{ RESOURCEGROUP }}-user{{ item }}-identity" \
          --resource-group "{{ RESOURCEGROUP }}" \
          --issuer "{{ ARO_OIDC_ISSUER }}" \
          --subject "system:serviceaccount:user{{ item }}:{{ SERVICE_ACCOUNT_NAME }}-user{{ item }}"
      register: fed_identity_cre_per_user
      loop: "{{ range(1, OCP4_WORKLOAD_USER_COUNT|int + 1)|list }}"
      when: OCP4_WORKLOAD_USER_COUNT|int > 0

    - name: Show raw registered variable
      debug:
        var: fed_identity_cre_per_user

- name: Save user info with clean output (per user)
  agnosticd_user_info:
    data:
      user_assigned_identity_object_id: "{{ identity_object_ids.results[n|int - 1].stdout }}"
      user_assigned_identity_client_id: "{{ identity_client_ids.results[n|int - 1].stdout }}"
    user: "user{{ n }}"
  loop: "{{ range(1, OCP4_WORKLOAD_USER_COUNT|int + 1)|list }}"
  loop_control:
    loop_var: n
  when: OCP4_WORKLOAD_USER_COUNT|int > 0