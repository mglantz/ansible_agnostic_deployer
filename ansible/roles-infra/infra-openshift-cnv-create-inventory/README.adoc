= infra-openshift-cnv-create-inventory

== What it does

- Discovers `kubevirt.io/v1` `VirtualMachine` objects in `openshift_cnv_namespace`.
- Optionally logs in to the cluster using `community.okd.openshift_auth` when username/password are provided.
- Finds a VM annotated with `AnsibleGroup` containing the string `bastions` and exposes it via a `NodePort` Service on port 22.
- Adds each discovered VM to the in-memory Ansible inventory with connection info and metadata from annotations.

== Key tasks

- `tasks/authentication.yaml`: optional login; stores token in `k8s_auth_results`.
- `tasks/create_inventory.yaml`:
  - Lists VMs in the namespace.
  - Exposes the bastion VM (`<name>-ssh` Service, type `NodePort`).
  - `add_host` for each VM with fields derived from VM annotations and role vars.

== Configuration

Role defaults (see `defaults/main.yaml`):

- `openshift_cnv_namespace` (string): Target namespace. Defaults to `sandbox_openshift_namespace` or `"<env_type>-<guid>"`.
- `openshift_cnv_instance_numeration` (string): Suffix pattern for instance numbering. Default: `"%d"`.
- `openshift_cnv_delete_retries` (int): Retries for delete operations. Default: 20.
- `openshift_cnv_delete_delay` (int): Delay between delete retries (seconds). Default: 60.
- `openshift_cnv_retries` (int): Generic retries for API operations. Default: 6.
- `openshift_cnv_delay` (int): Delay between retries (seconds). Default: 10.

Inputs used by tasks:

- `sandbox_openshift_api_url` (string): Cluster API URL.
- `sandbox_openshift_api_key` (string): API token; used if authentication task not run.
- `sandbox_openshift_username`/`sandbox_openshift_password` (strings): If set, role performs username/password login.
- `openshift_cnv_ssh_address` (string): Public IP/DNS used for `public_ip_address` in inventory.
- `remote_user` (string): SSH username set on inventory hosts.

Recognized VM annotations (on each `VirtualMachine`):

- `AnsibleGroup` (string): Comma-separated group list for host membership. If it contains `bastions`, the VM is treated as the bastion.
- `ansible_python_interpreter` (string): Set interpreter for the host. Defaults to `auto`.
- `managed` (bool): If `false`, VM is skipped from inventory.
- `external_ip` (string): Copied to host var `external_ip`.
- `external_ports` (string): Copied to host var `external_ports`.
- `isolated` (bool): Copied to host var `isolated`.

Inventory fields set per VM:

- `name`, `shortname`: VM name.
- `ansible_user`: from `remote_user`.
- `ansible_ssh_host`: VM name (DNS within cluster networking).
- `ssh_port` and `bastion_ssh_port`: NodePort from the exposed bastion Service (if any).
- `private_ip_address`: VM name.
- `public_ip_address`: `openshift_cnv_ssh_address`.
- `groups`: from `AnsibleGroup` annotation.
- `bastion`: detected bastion VM name or empty.

== Usage

Example play excerpt:

```yaml
- hosts: localhost
  gather_facts: false
  roles:
    - role: roles-infra/infra-openshift-cnv-create-inventory
      vars:
        sandbox_openshift_api_url: https://api.example:6443
        sandbox_openshift_api_key: "..."
        openshift_cnv_namespace: lab-{{ guid }}
        openshift_cnv_ssh_address: bastion.example.com
        remote_user: ec2-user
```
