---
- name: Check if registry credentials are provided
  ansible.builtin.fail:
    msg: >
      Registry authentication is enabled (registry_auth_enabled=true) but no credentials are provided.
      Please set either registry_username and registry_password, or registry_auth_token.
  when: >
    (registry_username | default('') == '' or registry_password | default('') == '') and 
    registry_auth_token | default('') == ''

- name: Ensure .config/containers directory exists for root user
  ansible.builtin.file:
    path: /root/.config/containers
    state: directory
    mode: '0700'
  become: true

- name: Ensure .config/containers directory exists for {{ student_name | default('dev') }} user
  ansible.builtin.file:
    path: "{{ '~' + vllm_user }}/.config/containers"
    state: directory
    mode: '0700'
  become: "{{ vllm_user != ansible_user_id }}"
  become_user: "{{ vllm_user }}"

- name: Configure registry auth via username/password for root
  ansible.builtin.shell: |
    podman login {{ registry_url }} -u {{ registry_username }} -p {{ registry_password }} --authfile /root/.config/containers/auth.json
  become: true
  no_log: true
  when: registry_username != '' and registry_password != ''
  changed_when: true

- name: Configure registry auth via username/password for {{ student_name | default('dev') }} user
  ansible.builtin.shell: |
    podman login {{ registry_url }} -u {{ registry_username }} -p {{ registry_password }} --authfile {{ '~' + vllm_user }}/.config/containers/auth.json
  become: "{{ vllm_user != ansible_user_id }}"
  become_user: "{{ vllm_user }}"
  no_log: true
  when: registry_username != '' and registry_password != ''
  changed_when: true

- name: Configure registry auth via token for root
  ansible.builtin.shell: |
    podman login {{ registry_url }} --authfile /root/.config/containers/auth.json --tls-verify=false --auth-token {{ registry_auth_token }}
  become: true
  no_log: true
  when: registry_auth_token != ''
  changed_when: true

- name: Configure registry auth via token for service user
  ansible.builtin.shell: |
    podman login {{ registry_url }} --authfile {{ '~' + vllm_user }}/.config/containers/auth.json --tls-verify=false --auth-token {{ registry_auth_token }}
  become: "{{ vllm_user != ansible_user_id }}"
  become_user: "{{ vllm_user }}"
  no_log: true
  when: registry_auth_token != ''
  changed_when: true

- name: Pre-pull container image
  ansible.builtin.command:
    cmd: podman pull {{ vllm_container_image }}
  become: true
  changed_when: true
