---

- name: Get NVIDIA GPU count
  ansible.builtin.command: 
    cmd: nvidia-smi --query-gpu=count --format=csv,noheader
  register: r_gpu_count_result
  changed_when: false
  failed_when: r_gpu_count_result.rc != 0
  ignore_errors: false
  check_mode: no

- name: Set fact for NVIDIA GPU count
  ansible.builtin.set_fact:
    f_nvidia_gpu_count: "{{ r_gpu_count_result.stdout }}"

- name: Create RHAIIS service file
  ansible.builtin.template:
    src: rhaiis.service.j2
    dest: /etc/systemd/system/rhaiis.service
    mode: u=rw,g=r,o=r
  become: true
  notify: reload systemd

- name: Ensure RHAIIS service is not Enabled or running 
  ansible.builtin.systemd:
    name: rhaiis
    enabled: false
    state: stopped
    daemon_reload: true
  become: true

- name: Start RHAIIS service
  when: setup_rhaiis_on_rhel_systemd_service_started | bool
  block:

    - name: Ensure RHAIIS service is Enabled and running 
      ansible.builtin.systemd:
        name: rhaiis
        enabled: true
        state: started
        daemon_reload: true
      become: true

    - name: Display message about waiting for RHAIIS service
      ansible.builtin.debug:
        msg: "Waiting for RHAIIS service to fully start. This may take several minutes while container images are downloaded..."

    - name: Wait for RHAIIS service to be fully operational
      ansible.builtin.uri:
        url: "http://localhost:{{ setup_rhaiis_on_rhel_vllm_port }}{{ setup_rhaiis_on_rhel_health_endpoint }}"
        method: GET
        status_code: 200
      register: result
      until: result.status == 200
      retries: "{{ setup_rhaiis_on_rhel_health_check_retries }}"
      delay: "{{ setup_rhaiis_on_rhel_health_check_delay }}"
      ignore_errors: true

    - name: Check RHAIIS service status
      ansible.builtin.command:
        cmd: systemctl status rhaiis
      register: service_status
      failed_when: false
      changed_when: false
      become: true

    - name: Display RHAIIS service status
      ansible.builtin.debug:
        var: service_status.stdout_lines

    - name: Verify RHAIIS container is running
      ansible.builtin.command:
        cmd: podman ps --filter name={{ setup_rhaiis_on_rhel_vllm_container_name }} --format "{{ '{{.Names}}' }}"
      register: container_status
      failed_when: false
      changed_when: false

    - name: Fail if RHAIIS service did not start properly
      ansible.builtin.fail:
        msg: "RHAIIS service failed to start properly. Please check the logs using 'journalctl -u rhaiis'."
      when: >
        (result is defined and result.status is not defined or result.status != 200) and
        (container_status.stdout == "" or service_status.rc != 0)
