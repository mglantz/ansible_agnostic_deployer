---
- name: Annotate and label resources
  ansible.builtin.shell: |
    oc annotate subscriptions.operators.coreos.com/openshift-gitops-operator meta.helm.sh/release-name=tssc-subscriptions -n openshift-operators
    oc annotate subscriptions.operators.coreos.com/openshift-gitops-operator meta.helm.sh/release-namespace=tssc -n openshift-operators
    oc label subscriptions.operators.coreos.com/openshift-gitops-operator app.kubernetes.io/managed-by=Helm -n openshift-operators

- name: Retrieve Gitlab root private token
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: root-user-personal-token
    namespace: "{{ ocp4_workload_advanced_developer_suite_gitlab_namespace }}"
  register: r_root_token
  retries: 120
  delay: 10
  until:
  - r_root_token is defined
  - r_root_token.resources is defined
  - r_root_token.resources | length > 0
  - r_root_token.resources[0] is defined
  - r_root_token.resources[0].data is defined
  - r_root_token.resources[0].data.token is defined
  - r_root_token.resources[0].data.token | length > 0

- name: Decode root token
  ansible.builtin.set_fact:
    _gitlab_root_token: "{{ r_root_token.resources[0].data.token | b64decode }}"

- name: Integrate gitlab
  become: true
  ansible.builtin.shell: |
    ./bin/tssc integration gitlab \
    --token="{{ _gitlab_root_token }}" \
    --host="{{ _gitlab_host }}" \
    --group="{{ ocp4_workload_advanced_developer_suite_tssc_cli_gitlab_group }}"
  args:
    chdir: ~/tssc_cli

- name: Wait until Jenkins is fully up and running
  k8s_info:
    api_version: v1
    kind: Deployment
    name: jenkins
    namespace: "{{ ocp4_workload_advanced_developer_suite_jenkins_namespace }}"
  register: r_jenkins
  retries: 60
  delay: 10
  until:
  - r_jenkins.resources[0].status is defined
  - r_jenkins.resources[0].status.readyReplicas is defined
  - r_jenkins.resources[0].status.readyReplicas == r_jenkins.resources[0].spec.replicas

- name: Generate Jenkins API Token
  uri:
    url: "{{ _jenkins_url }}/me/descriptorByName/jenkins.security.ApiTokenProperty/generateNewToken"
    user: "{{ ocp4_workload_advanced_developer_suite_jenkins_admin_user }}"
    password: "{{ ocp4_workload_advanced_developer_suite_jenkins_admin_password }}"
    method: POST
    force_basic_auth: true
    validate_certs: false
    body_format: form-urlencoded
    body:
      newTokenName: backstage
  register: r_jenkins_token
  retries: 60
  delay: 10
  until: r_jenkins_token is not failed

- name: Set Jenkins Token Fact
  set_fact:
    _jenkins_token: "{{ r_jenkins_token.json.data.tokenValue }}"

- name: Integrate jenkins
  become: true
  ansible.builtin.shell: |
    ./bin/tssc integration jenkins \
    --token="{{ _jenkins_token }}" \
    --url="{{ _jenkins_url }}" \
    --username="{{ ocp4_workload_advanced_developer_suite_jenkins_admin_user }}"
  args:
    chdir: ~/tssc_cli