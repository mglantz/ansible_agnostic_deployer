---
- name: Retrieve gitops credentials
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: tssc-gitops-cluster
    namespace: "{{ ocp4_workload_advanced_developer_suite_tssc_gitops_namespace }}"
  register: r_gitops_credentials
  retries: 120
  delay: 10
  until:
  - r_gitops_credentials is defined
  - r_gitops_credentials.resources is defined
  - r_gitops_credentials.resources | length > 0

- name: Retrieve gitops credentials
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: tpa-realm-chicken-admin
    namespace: "{{ ocp4_workload_advanced_developer_suite_tssc_tpa_namespace }}"
  register: r_tpa_credentials
  retries: 120
  delay: 10
  until:
  - r_tpa_credentials is defined
  - r_tpa_credentials.resources is defined
  - r_tpa_credentials.resources | length > 0

- name: Retrieve quay credentials
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: tssc-quay-super-user
    namespace: "{{ ocp4_workload_advanced_developer_suite_quay_namespace }}"
  register: r_quay_credentials
  retries: 120
  delay: 10
  until:
  - r_quay_credentials is defined
  - r_quay_credentials.resources is defined
  - r_quay_credentials.resources | length > 0

- name: Retrieve acs credentials
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: central-htpasswd
    namespace: "{{ ocp4_workload_advanced_developer_suite_acs_namespace }}"
  register: r_acs_credentials
  retries: 120
  delay: 10
  until:
  - r_acs_credentials is defined
  - r_acs_credentials.resources is defined
  - r_acs_credentials.resources | length > 0

- name: Save user information
  block:
  - name: Save user information for user access
    agnosticd_user_info:
      user: "{{ ocp4_workload_advanced_developer_suite_user_base_name }}{{ n + 1 }}"
      data:
        openshift_admin_user: "{{ ocp4_workload_advanced_developer_suite_admin_user }}"
        openshift_admin_password: "{{ ocp4_workload_advanced_developer_suite_admin_password }}"
        rhdh_url: "{{ _dh_url }}"
        rhdh_auth: oidc
        rhdh_user: "{{ ocp4_workload_advanced_developer_suite_user_base_name }}{{ n + 1 }}"
        rhdh_user_password: "{{ ocp4_workload_advanced_developer_suite_user_password }}"
        gitops_url: "{{ _gitops_url }}"
        gitops_admin_user: admin
        gitops_admin_password: "{{ r_gitops_credentials.resources[0].data['admin.password'] | b64decode }}"
        gitlab_url: "{{ _gitlab_url }}"
        gitlab_user: "{{ ocp4_workload_advanced_developer_suite_user_base_name }}{{ n + 1 }}"
        gitlab_user_password: "{{ ocp4_workload_advanced_developer_suite_user_password }}"
        devspaces_url: "{{ _devspaces_url }}"
        devspaces_user: "{{ ocp4_workload_advanced_developer_suite_user_base_name }}{{ n + 1 }}"
        devspaces_user_password: "{{ ocp4_workload_advanced_developer_suite_user_password }}"
        tpa_url: "{{ _tpa_url }}"
        tpa_user: "{{ r_tpa_credentials.resources[0].data.username | b64decode }}"
        tpa_user_password: "{{ r_tpa_credentials.resources[0].data.password | b64decode }}"
        quay_url: "{{ _quay_url }}"
        quay_admin_user: "{{ r_quay_credentials.resources[0].data.username | b64decode }}"
        quay_admin_password: "{{ r_quay_credentials.resources[0].data.password | b64decode }}"
        acs_url: "{{ _acs_url }}"
        acs_admin_user: "{{ ocp4_workload_advanced_developer_suite_acs_admin_user }}"
        acs_admin_password: "{{ r_acs_credentials.resources[0].data.password | b64decode }}"
    loop: "{{ range(0, ocp4_workload_advanced_developer_suite_user_count | int) | list }}"
    loop_control:
      loop_var: n