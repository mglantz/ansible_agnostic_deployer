---
- name: Post Workload Tasks
  debug:
    msg: "Post-Workload tasks Started"

# Keycloak user verification is handled in main workload.yml

# GitLab user verification is handled in main workload.yml

- name: Wait for showroom deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: "showroom-{{ _dynamic_username }}"
    namespace: "{{ _dynamic_showroom_namespace }}"
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300
  register: r_showroom_deployment
  when: _showroom_content_repo is defined and _showroom_content_repo != ""

- name: Get showroom route
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    namespace: "{{ _dynamic_showroom_namespace }}"
  register: r_showroom_route
  when: _showroom_content_repo is defined and _showroom_content_repo != ""


- name: Set showroom URL
  ansible.builtin.set_fact:
    _showroom_url: "https://{{ r_showroom_route.resources[0].spec.host }}"
  when:
    - _showroom_content_repo is defined
    - _showroom_content_repo != ""
    - r_showroom_route.resources is defined
    - r_showroom_route.resources | length > 0


- name: Add showroom URL to user data
  agnosticd_user_info:
    user: "{{ _dynamic_username }}"
    data:
      showroom_url: "{{ _showroom_url | default('') }}"

- name: Report user creation status
  agnosticd_user_info:
    msg: |
      Dynamic user {{ _dynamic_username }} has been successfully created for workshop {{ guid }}.
      {% if _showroom_url is defined %}Access your lab: {{ _showroom_url }}{% endif %}

- name: Post Workload Tasks Complete
  debug:
    msg: "Post-Workload tasks completed successfully"
