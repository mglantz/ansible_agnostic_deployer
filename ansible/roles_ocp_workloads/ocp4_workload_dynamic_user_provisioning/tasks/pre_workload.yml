---
- name: Pre Workload Tasks
  debug:
    msg: "Pre-Workload tasks Started"

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - guid is defined
      - guid != ''
      - ocp4_workload_dynamic_user_provisioning_admin_user is defined
      - ocp4_workload_dynamic_user_provisioning_admin_user != ''
      - ocp4_workload_dynamic_user_provisioning_admin_password is defined
      - ocp4_workload_dynamic_user_provisioning_admin_password != ''
      - ocp4_workload_dynamic_user_provisioning_openshift_api_url is defined
      - ocp4_workload_dynamic_user_provisioning_openshift_api_url != ''
    fail_msg: "Required variables are not defined. Need: guid, admin_user, admin_password, openshift_api_url"

- name: Set dynamic user facts
  ansible.builtin.set_fact:
    _dynamic_username: "user-{{ guid }}"
    _dynamic_user_email: "user-{{ guid }}@demo.redhat.com"
    _dynamic_showroom_namespace: "{{ ocp4_workload_dynamic_user_provisioning_showroom_namespace }}-user-{{ guid }}"

- name: Debug dynamic user information
  ansible.builtin.debug:
    msg:
      - "Workshop GUID: {{ guid }}"
      - "Dynamic Username: {{ _dynamic_username }}"
      - "Dynamic User Email: {{ _dynamic_user_email }}"
      - "Showroom Namespace: {{ _dynamic_showroom_namespace }}"

- name: Extract cluster domain from API URL
  ansible.builtin.set_fact:
    _cluster_domain: >-
      {{
        ocp4_workload_dynamic_user_provisioning_openshift_api_url
        | regex_replace('^https://api\.', '')
        | regex_replace(':6443/?$', '')
      }}

- name: Set OpenShift Apps Domain
  ansible.builtin.set_fact:
    _ocp_apps_domain: "apps.{{ _cluster_domain }}"

- name: Debug domain extraction
  ansible.builtin.debug:
    msg:
      - "OpenShift API URL: {{ ocp4_workload_dynamic_user_provisioning_openshift_api_url }}"
      - "Extracted Cluster Domain: {{ _cluster_domain }}"
      - "Final Apps Domain: {{ _ocp_apps_domain }}"

- name: Login to OpenShift using oc command (handles Keycloak auth)
  ansible.builtin.shell: |
    oc login {{ ocp4_workload_dynamic_user_provisioning_openshift_api_url }} \
      --username={{ ocp4_workload_dynamic_user_provisioning_admin_user }} \
      --password={{ ocp4_workload_dynamic_user_provisioning_admin_password }} \
      --insecure-skip-tls-verify=true
  register: r_oc_login
  changed_when: true

- name: Test OpenShift connection after login
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: kube-system
  register: r_connection_test

- name: Debug OpenShift authentication
  ansible.builtin.debug:
    msg:
      - "OpenShift API Server: {{ ocp4_workload_dynamic_user_provisioning_openshift_api_url }}"
      - "Login User: {{ ocp4_workload_dynamic_user_provisioning_admin_user }}"
      - "Login result: {{ r_oc_login.stdout }}"
      - "Connection successful: {{ r_connection_test.resources is defined }}"

- name: Check if Keycloak namespace exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ ocp4_workload_dynamic_user_provisioning_keycloak_namespace }}"
  register: r_keycloak_namespace

- name: Fail if Keycloak namespace not found
  ansible.builtin.fail:
    msg: "Keycloak namespace {{ ocp4_workload_dynamic_user_provisioning_keycloak_namespace }} not found. Ensure the workshop is properly deployed."
  when: r_keycloak_namespace.resources | length == 0

- name: Check if GitLab namespace exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ ocp4_workload_dynamic_user_provisioning_gitlab_namespace }}"
  register: r_gitlab_namespace

- name: Fail if GitLab namespace not found
  ansible.builtin.fail:
    msg: "GitLab namespace {{ ocp4_workload_dynamic_user_provisioning_gitlab_namespace }} not found. Ensure the workshop is properly deployed."
  when: r_gitlab_namespace.resources | length == 0

- name: Pre Workload Tasks Complete
  debug:
    msg: "Pre-Workload tasks completed successfully"
