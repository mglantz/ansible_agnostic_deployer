---
# -------------------------------------------------------------------------
# Workload tasks: Pull image to podvm and setup oc bash completion
# -------------------------------------------------------------------------

- name: Ensure podvm root directory exists
  ansible.builtin.file:
    path: /podvm
    state: directory
    mode: '0755'
  become: true

- name: Change ownership of /podvm to azure:azure
  ansible.builtin.file:
    path: /podvm
    owner: azure
    group: azure
  become: true

- name: Generate cluster pull secret file from OpenShift
  ansible.builtin.shell: |
    oc get -n openshift-config secret/pull-secret -o json \
    | jq -r '.data.".dockerconfigjson"' \
    | base64 -d \
    | jq '.' > {{ ocp4_workload_coco_on_aro_authfile }}
  args:
    chdir: "{{ ansible_env.HOME | default('/root') }}"
  register: pull_secret_result
  changed_when: pull_secret_result.rc == 0
  retries: 3
  delay: 5

- name: Get image digest using skopeo
  ansible.builtin.shell: |
    skopeo inspect --authfile ./{{ ocp4_workload_coco_on_aro_authfile }} \
    docker://{{ ocp4_workload_coco_on_aro_verity_image }}:{{ ocp4_workload_coco_on_aro_osc_version }} \
    | jq -r .Digest
  args:
    chdir: "{{ ansible_env.HOME | default('/root') }}"
  register: image_digest_result
  when: ocp4_workload_coco_on_aro_image == ""
  changed_when: false
  retries: 3
  delay: 5

- name: Set image variable from digest
  ansible.builtin.set_fact:
    ocp4_workload_coco_on_aro_image: "{{ ocp4_workload_coco_on_aro_verity_image }}@{{ image_digest_result.stdout }}"
  when: ocp4_workload_coco_on_aro_image == ""

- name: Validate image variable is set
  ansible.builtin.assert:
    that:
      - ocp4_workload_coco_on_aro_image != ""
    fail_msg: "Image variable is not set. Either provide ocp4_workload_coco_on_aro_image or ensure skopeo can retrieve the digest."
    success_msg: "Image variable is set: {{ ocp4_workload_coco_on_aro_image }}"

- name: Pull image to podvm using cluster pull secret
  containers.podman.podman_image:
    name: "{{ ocp4_workload_coco_on_aro_image }}"
    pull: true
    pull_extra_args: "--root /podvm --authfile {{ ansible_env.HOME | default('/root') }}/{{ ocp4_workload_coco_on_aro_authfile }}"
  retries: 3
  delay: 10

- name: Pull coco-tools image to default podman location
  containers.podman.podman_image:
    name: quay.io/confidential-devhub/coco-tools:0.3.0
    pull: true
  retries: 3
  delay: 10

- name: Generate oc bash completion script
  ansible.builtin.command:
    cmd: oc completion bash
    chdir: "{{ ansible_env.HOME | default('/root') }}"
  register: oc_completion_result
  changed_when: oc_completion_result.rc == 0
  retries: 3
  delay: 5

- name: Write oc bash completion to file
  ansible.builtin.copy:
    content: "{{ oc_completion_result.stdout }}"
    dest: "{{ ansible_env.HOME | default('/root') }}/oc_bash_completion"
    mode: '0644'

- name: Copy oc bash completion to system directory
  ansible.builtin.copy:
    src: "{{ ansible_env.HOME | default('/root') }}/oc_bash_completion"
    dest: /etc/bash_completion.d/oc_bash_completion
    mode: '0644'
    remote_src: true
  become: true

- name: Add oc bash completion source to bashrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME | default('/root') }}/.bashrc"
    line: "source /etc/bash_completion.d/oc_bash_completion"
    create: true
    state: present
    regexp: '^source /etc/bash_completion.d/oc_bash_completion'

- name: Workload tasks complete
  ansible.builtin.debug:
    msg: "PodVM image pull and oc completion setup completed successfully"
