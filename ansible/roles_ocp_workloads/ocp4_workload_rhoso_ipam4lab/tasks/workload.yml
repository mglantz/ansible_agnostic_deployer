---
# Implement your Workload deployment tasks here

- name: Allocate IP addresses from IPAM4Lab service
  block:
  - name: Call IPAM4Lab allocation API
    ansible.builtin.uri:
      url: "{{ ocp4_workload_rhoso_ipam4lab_service_url }}/allocate"
      method: POST
      body_format: json
      body:
        lab_uid: "{{ ocp4_workload_rhoso_ipam4lab_allocation_name }}"
        cluster: "{{ ocp4_workload_rhoso_ipam4lab_cluster_name }}"
      headers:
        Content-Type: "application/json"
      timeout: "{{ ocp4_workload_rhoso_ipam4lab_request_timeout }}"
      status_code: [200, 201]
    register: r_ipam_allocation

  - name: Parse allocation response
    ansible.builtin.set_fact:
      _ipam_allocation_data: "{{ r_ipam_allocation.json }}"

  - name: Extract IP allocation variables
    ansible.builtin.set_fact:
      _ipam_worker_ip_1: "{{ _ipam_allocation_data.allocation.EXTERNAL_IP_WORKER_1 }}"
      _ipam_worker_ip_2: "{{ _ipam_allocation_data.allocation.EXTERNAL_IP_WORKER_2 }}"
      _ipam_worker_ip_3: "{{ _ipam_allocation_data.allocation.EXTERNAL_IP_WORKER_3 }}"
      _ipam_bastion_ip: "{{ _ipam_allocation_data.allocation.EXTERNAL_IP_BASTION }}"
      _ipam_public_net_start: "{{ _ipam_allocation_data.allocation.PUBLIC_NET_START }}"
      _ipam_public_net_end: "{{ _ipam_allocation_data.allocation.PUBLIC_NET_END }}"
      _ipam_conversion_host_ip: "{{ _ipam_allocation_data.allocation.CONVERSION_HOST_IP }}"
      _ipam_allocation_name: "{{ _ipam_allocation_data.lab_uid | default(_ipam_allocation_data.name) }}"
      _ipam_cluster_name: "{{ _ipam_allocation_data.cluster }}"
      _ipam_subnet: "{{ _ipam_allocation_data.subnet }}"
      _ipam_network: "{{ _ipam_allocation_data.network }}"

  - name: Debug allocation details
    when: not silent | bool
    ansible.builtin.debug:
      msg:
      - "IPAM4Lab allocation successful:"
      - "  Allocation name: {{ _ipam_allocation_name }}"
      - "  Cluster: {{ _ipam_cluster_name }}"
      - "  Subnet: {{ _ipam_subnet }}"
      - "  Network: {{ _ipam_network }}"
      - "  Worker IPs: {{ _ipam_worker_ip_1 }}, {{ _ipam_worker_ip_2 }}, {{ _ipam_worker_ip_3 }}"
      - "  Bastion IP: {{ _ipam_bastion_ip }}"
      - "  Public network range: {{ _ipam_public_net_start }} - {{ _ipam_public_net_end }}"
      - "  Conversion host IP: {{ _ipam_conversion_host_ip }}"

  rescue:
  - name: IPAM allocation failed
    ansible.builtin.fail:
      msg: |
        Failed to allocate IP addresses from IPAM4Lab service:
        URL: {{ ocp4_workload_rhoso_ipam4lab_service_url }}/allocate
        Error: {{ r_ipam_allocation.msg | default('Unknown error') }}
        Status code: {{ r_ipam_allocation.status | default('N/A') }}

- name: Workload tasks complete
  when: not silent | bool
  ansible.builtin.debug:
    msg: "Workload tasks completed successfully."
