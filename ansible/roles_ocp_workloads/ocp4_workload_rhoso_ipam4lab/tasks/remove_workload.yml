---
# Implement your Workload removal tasks here

- name: Deallocate IP addresses from IPAM4Lab service
  block:
  - name: Call IPAM4Lab deallocation API
    ansible.builtin.uri:
      url: "{{ ocp4_workload_rhoso_ipam4lab_service_url }}/deallocate"
      method: DELETE
      body_format: json
      body:
        lab_uid: "{{ ocp4_workload_rhoso_ipam4lab_allocation_name }}"
        cluster: "{{ ocp4_workload_rhoso_ipam4lab_cluster_name }}"
      headers:
        Content-Type: "application/json"
      timeout: "{{ ocp4_workload_rhoso_ipam4lab_request_timeout }}"
      status_code: [200, 404]  # 404 is acceptable if allocation doesn't exist
    register: r_ipam_deallocation

  - name: Debug deallocation result
    when: not silent | bool
    ansible.builtin.debug:
      msg:
      - "IPAM4Lab deallocation result:"
      - "  Allocation name: {{ ocp4_workload_rhoso_ipam4lab_allocation_name }}"
      - "  Cluster: {{ ocp4_workload_rhoso_ipam4lab_cluster_name }}"
      - "  Status: {{ r_ipam_deallocation.json.message | default('Deallocation successful') }}"

  rescue:
  - name: IPAM deallocation warning
    when: not silent | bool
    ansible.builtin.debug:
      msg: |
        Warning: Failed to deallocate IP addresses from IPAM4Lab service:
        URL: {{ ocp4_workload_rhoso_ipam4lab_service_url }}/deallocate
        Allocation: {{ ocp4_workload_rhoso_ipam4lab_allocation_name }}
        Error: {{ r_ipam_deallocation.msg | default('Unknown error') }}
        This may be expected if the allocation was already removed or never existed.

- name: Remove_workload tasks complete
  when: not silent | bool
  ansible.builtin.debug:
    msg: "Remove-Workload tasks completed successfully."
